---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: tvheadend
  namespace: media
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: tvheadend
      version: 3.2.0
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system
      interval: 5m
  timeout: 20m
  values:
    image:
      repository: linuxserver/tvheadend
      tag: release-4.2
    env:
      TZ: "Europe/Warsaw"
      PUID: 1000
      PGID: 1000
      RUN_OPTS: "-d -l --debug -l --subsystems -l --trace -l --libav -l --uidebug"
    strategy:
      type: Recreate
    nodeSelector:
      k3s.io/hostname: "wezyr"
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: "nginx"
        nginx.ingress.kubernetes.io/auth-url: "https://auth.${SECRET_DOMAIN}/oauth2/auth"
        nginx.ingress.kubernetes.io/auth-signin: https://auth.${SECRET_DOMAIN}/oauth2/start
        forecastle.stakater.com/expose: "true"
        forecastle.stakater.com/icon: "https://avatars.githubusercontent.com/u/1908588?s=400&v=4"
      hosts:
      - host: tvheadend.${SECRET_DOMAIN}
        paths:
        - path: /
          pathType: Prefix
      tls:
      - hosts:
         - "tvheadend.${SECRET_DOMAIN}"
      additionalIngresses:
        - nameSuffix: stream
          enabled: true
          annotations:
            kubernetes.io/ingress.class: "nginx"
          hosts:
          - host: tvheadend.${SECRET_DOMAIN}
            paths:
            - path: /
              pathType: Prefix
              serviceName: tvheadend
              servicePort: 9982
          tls:
          - hosts:
             - "tvheadend.${SECRET_DOMAIN}"
    persistence:
      config:
        enabled: true
        existingClaim: config-tvheadend-pvc
    additionalVolumeMounts:
    - name: dvb
      mountPath: /dev/dvb
    - name: dri
      mountPath: /dev/dri
    - name: recordings-omv
      mountPath: "/recordings"
    additionalVolumes:
    - name: dvb
      hostPath:
        path: /dev/dvb
    - name: dri
      hostPath:
        path: /dev/dri
    - name: recordings-omv
      persistentVolumeClaim:
        claimName: nfs-recordings-omv-pvc
    service:
      type: LoadBalancer
      loadBalancerIP: 192.168.1.211
      port:
        port: 80
        targetPort: 9981
      additionalPorts:
        port:
          port: 9982
          name: htsp
    securityContext:
      privileged: true
      #  runAsUser: 1000
      #  runAsGroup: 1000
      #  fsGroup: 1000
    resources:
      requests:
        cpu: 1
        memory: 128Mi
      limits:
        cpu: 2
        memory: 1500Mi
